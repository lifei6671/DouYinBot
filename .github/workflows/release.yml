name: Release on Tag

on:
  push:
    tags:
      - '*' # 监听所有标签

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest

    steps:
      # 检出代码
      - name: Checkout Code
        uses: actions/checkout@v3

      # 安装依赖
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebp-dev musl-tools musl-dev

      # 设置 Go 环境
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.23

      # 获取当前标签
      - name: Get Tag Name
        id: vars
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      # 构建 Go 二进制文件
      - name: Build Binaries
        run: |
          mkdir -p dist
          # 静态链接 Linux amd64
          CGO_ENABLED=1 CC=musl-gcc \
          CGO_CFLAGS="-I/usr/include" \
          CGO_LDFLAGS="-L/usr/lib -lwebp -static" \
          GOOS=linux GOARCH=amd64 go build -o dist/douyinbot-linux-amd64 main.go

          # 静态链接 Linux arm64
          CGO_ENABLED=1 CC=musl-gcc \
          CGO_CFLAGS="-I/usr/include" \
          CGO_LDFLAGS="-L/usr/lib -lwebp -static" \
          GOOS=linux GOARCH=arm64 go build -o dist/douyinbot-linux-arm64 main.go

      # 创建 Release 并上传二进制文件
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/douyinbot-linux-amd64
            dist/douyinbot-linux-arm64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 登录 Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 构建 Docker 镜像
      - name: Build Docker Image
        run: |
          docker build -t docker.io/${{ secrets.DOCKERHUB_USERNAME }}/douyinbot:${{ env.tag }} .

      # 推送 Docker 镜像
      - name: Push Docker Image
        run: |
          # 添加 latest 标签
          docker tag docker.io/${{ secrets.DOCKERHUB_USERNAME }}/douyinbot:${{ env.tag }} docker.io/${{ secrets.DOCKERHUB_USERNAME }}/douyinbot:latest

          # 推送带版本号的标签
          docker push docker.io/${{ secrets.DOCKERHUB_USERNAME }}/douyinbot:${{ env.tag }}

          # 推送 latest 标签
          docker push docker.io/${{ secrets.DOCKERHUB_USERNAME }}/douyinbot:latest
